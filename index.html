<!doctype html>
<html><head><meta charset="utf-8" />
<title>Art Makes Programs</title>
<style></style>
</head><body>

<script>
  
  var  stack  = []                                      // parameter stack
  var rstack  = []                                      // return stack
  var memory  = [] // TODO: make this a byte array
  
  var codes   = [] // TODO: make this a byte array
  var pc      = -1                                       // program counter
  
  function run(program) {
    pc = -1
    stack  = []
    rstack = []
    codes = program
    while(step(pc++) !== false) {}
    console.log(memory, stack)
  }
  
  function step() {
    var code = codes[pc]
    if(code == null) return false
    if(dict[code])
      return dict[code]() // TODO: map from # to code, then dict
    else
      push(code)
  }
  
  function scan_to_sub(how_far) {
    // TODO: do it more if needed
    //  % 4 // NOTE: 4 is magic
    var addr = next_exit(pc)
    if(!addr) return false                              // cause 0 addr would be silly
    return addr+1
  }
  
  function next_exit(offset) {
    for(var i = offset+1; i < codes.length; i++)        // +1 for luck
      if(codes[i] == 'exit') // TODO: map # to code
        return i
  }
  
  function push(val) {
    stack.push( (val | 0) % 255)
  }
  
  var dict = {}
  dict['+']    = function() {var x = stack.pop(); push((stack.pop() + x) | 0)}
  dict['-']    = function() {var x = stack.pop(); push((stack.pop() - x) | 0)}
  dict['*']    = function() {var x = stack.pop(); push((stack.pop() * x) | 0)}
  dict['/']    = function() {var x = stack.pop(); push((stack.pop() / x) | 0)}
  
  dict['>M']   = function() {var addr = stack.pop(); var value = stack.pop(); memory[addr] = value}
  dict['M>']   = function() {var addr = stack.pop(); push(memory[addr])}
                 
  dict['abs' ] = function() {push(Math.abs(stack.pop()))}
  dict['max' ] = function() {push(Math.max(stack.pop(), stack.pop()))}
  dict['min' ] = function() {push(Math.min(stack.pop(), stack.pop()))}
  
  dict['drop'] = function() {stack.pop()}
  dict['pick'] = function() {var p=stack.pop(); push(stack[stack.length-p-1])}
  dict['roll'] = function() {var p=stack.pop(); var x=stack[stack.length-p-1]; stack.splice(stack.length-p-1, 1); push(x)}

  dict['jump'] = function() {
    rstack.push(pc)
    var how_far = stack.pop()
    var addr = scan_to_sub(how_far)
    if(!addr) return dict['exit']()                     // YOLO
    pc = addr
  } 
  
  dict['exit'] = function() {
    if(!rstack.length) return false                     // stop execution
    var addr = rstack.pop()
    pc = addr
  }
  
  // TESTS
  
  run([1, 2, 3, 4, '+', '*', '+'])
  if(stack[0] != 15 || !stack.length) console.error('ASDF!')
  
  memory  = [0, 0, 100, 0, 100, 0, 0, 0, 100, 0, 0, 0]
  program = [ 10, 'jump', 'exit'  // loop sub 10 times
            , 'dup', 'dup'        // copy loop index twice
            , 1, '-'              // take one less than loop index
            , 'M>', 1, 'pick'     // grab from mem, roll under loop index
            , 'M>'                // grab from mem
            , '+', 2, '/'         // average
            , 1, 'pick'           // value then address
            , '>M'                // put it back in memory at loop index
            , 'exit']             // return from sub

  // run(program)
  
</script>
</body></html>