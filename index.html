<!doctype html>
<html><head><meta charset="utf-8" />
<title>Art Makes Programs</title>
<style></style>
</head><body>

<script>
  
  var  stack  = []                                      // parameter stack
  var rstack  = []                                      // return stack
  var memory  = [] // TODO: make this a byte array
  
  var codes   = [] // TODO: make this a byte array
  var pc      = 0                                       // program counter
  
  function run(program) {
    codes = program
    while(step()) {}
    console.log(memory)
  }
  
  function step() {
    var code = codes[pc]
    if(dict[code])
      dict[code]() // TODO: map from # to code, then dict
    else
      stack.push(code)
  }
  
  function scan_to_sub(how_far) {
    // TODO: do it more if needed
    //  % 4 // NOTE: 4 is magic
    var addr = next_exit(pc)
    if(!addr) return false                              // cause 0 addr would be silly
    return addr+1
  }
  
  function next_exit(offset) {
    for(var i = offset+1; i < codes.length; i++)        // +1 for luck
      if(codes[i] == 'exit') // TODO: map # to code
        return i
  }
  
  var dict = {}
  dict['+']    = function() {var x = stack.pop(); stack.push((stack.pop() + x) | 0)}
  dict['-']    = function() {var x = stack.pop(); stack.push((stack.pop() - x) | 0)}
  dict['*']    = function() {var x = stack.pop(); stack.push((stack.pop() * x) | 0)}
  dict['/']    = function() {var x = stack.pop(); stack.push((stack.pop() / x) | 0)}
  
  dict['>M']   = function() {var addr = stack.pop(); var value = stack.pop(); memory[addr] = value}
  dict['M>']   = function() {var addr = stack.pop(); stack.push(memory[addr])}
                 
  dict['abs' ] = function() {stack.push(Math.abs(stack.pop()))}
  dict['max' ] = function() {stack.push(Math.max(stack.pop(), stack.pop()))}
  dict['min' ] = function() {stack.push(Math.min(stack.pop(), stack.pop()))}
  
  dict['drop'] = function() {stack.pop()}
  dict['pick'] = function() {var p=stack.pop(); stack.push(stack[stack.length-p-1])}
  dict['roll'] = function() {var p=stack.pop(); var x=stack[stack.length-p-1]; stack.splice(stack.length-p-1, 1); stack.push(x)}

  dict['jump'] = function() {
    rstack.push(pc)
    var how_far = stack.pop()
    if(!how_far)
    pc = scan_to_sub(how_far)
  } 
  
  dict['exit'] = function() {
    if(!rstack.length) return false                     // stop execution
    var addr = rstack.pop()
    pc = addr
  }
  
</script>
</body></html>