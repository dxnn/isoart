<!doctype html>
<html><head><meta charset="utf-8" />
<style>
  canvas {
    height: 688px;
    width: 50px;
    float: left;
    background: black;
    margin: 2px;
  }
</style>
</head><body>

<div id="bottom"></div>

<script>

  var pc = 0            // "current" operation
  var files = {}        // file name and context
  var ordering = []     // every invocation in order
  var invocations = {}  // full invocation data
  var active = {}       // used for rendering
  
  var fillStyle = ''    // cache for perf

  function receiveMessage(event) {
    var data = event.data

    for(var i = data.length - 1; i >= 0; i--) {
      var item = data[i]
      var key  = item[0]
      var name = item[1]
      
      if(invocations[key]) {
        invocations[key].count++
        ordering.push(invocations[key])
        continue
      }
        
      var pieces   = key.split('-')
      var end      = [pieces.pop(), pieces.pop()]
      var start    = [pieces.pop(), pieces.pop()]
      var filename = pieces.join('-')
      
      var file = build_file(filename)
      
      var invocation = {file: file, start: start, end: end, name: name, key: key, count: 0}
      invocations[key] = invocation
      
      ordering.push(invocation)
    }
  }

  function build_file(filename) {
    if(files[filename]) return files[filename]

    // build new canvas
    var canvas_name = 'canvas-' + filename
    var canvas = document.createElement('canvas')
    canvas.setAttribute('id', canvas_name)
    canvas.setAttribute('height', 688)
    canvas.setAttribute('width', 50)
    document.body.insertBefore(canvas, bottom)
    var ctx = document.getElementById(canvas_name).getContext('2d')
  
    // TODO: mouseovers
    
    files[filename] = { name: filename
                      , ctx: ctx
                      }
                  
    return files[filename]
  }
  
  function render_item(item, fill) {
    var start = item.start
    var end   = item.end
    
    var file  = item.file
    var ctx = file.ctx

    var x = Math.min((start[0] / 2), 50)
    var y = start[1]
  
    if(y > 500)
      y = 500 + Math.sqrt(y)
      
    if(fill != fillStyle) {
      fillStyle = fill
      ctx.fillStyle = fill
    }

    ctx.fillRect(x, y, 2, 2)
  }
  
  function render_cooldowns() {
    var delete_me = []
    
    for(var key in active) {
      var age = active[key]
      var item = invocations[key]

      // var count = item.count

      
      var fill = 'hsl(' + (200-(age*40)) + ', 100%, 80%)'
      render_item(item, fill)
      
      if(age >= 5)
        delete_me.push(key)
      else
        active[key]++
    }
    
    delete_me.forEach(function(key) {
      delete(active[key])
    })
  }
  
  function render_selection(from, to) {
    var fill = 'hsl(' + 0 + ', 100%, 80%)'

    for(var i = from; i < to; i++) {
      var item  = ordering[i]
      active[item.key] = 0
      render_item(item, fill)
    }
    
    render_cooldowns()
  }
  
  function render_inc(increment) {
    var from = pc
    var to   = pc + increment

    if(from >= ordering.length-1) // off-by-one
      return false

    if(to >= ordering.length)
      to = ordering.length-1

    render_selection(from, to)

    pc = pc + increment      
  }
  
  function clear_files() {
    for(var key in files) {
      files[key].ctx.clearRect(0, 0, 1000, 1000)
    }
  }
  
  
  gap = 10
  delta = 100
  function render_loop() {
    render_inc(gap)
    setTimeout(render_loop, delta)
  }
  window.addEventListener("message", receiveMessage, false);
 
</script>
</body></html>